import re
import os
import hashlib
import time


# 二进制文件名称
inputbin = "MoWatchAPP.bin"
# 应用程序名称
outputmwa = "Avatar.mwa"

# 应用程序图标 - 人物头像
# [数据排列]:从左到右从上到下
# [取模方式]:横向8点左高位
# [正负反色]:否
# 图像尺寸:48x48 画布尺寸:48x48，共288个字节
appicon_bmp = [
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xE0,0x07,0xFF,0xFF,
    0xFF,0xFE,0x00,0x00,0x7F,0xFF,
    0xFF,0xF0,0x00,0x00,0x0F,0xFF,
    0xFF,0xC0,0x00,0x00,0x03,0xFF,
    0xFF,0x80,0x00,0x00,0x01,0xFF,
    0xFF,0x00,0x00,0x00,0x00,0xFF,
    0xFE,0x00,0x00,0x00,0x00,0x7F,
    0xFC,0x00,0x00,0x00,0x00,0x3F,
    0xF8,0x00,0x00,0x00,0x00,0x1F,
    0xF8,0x00,0x00,0x00,0x00,0x1F,
    0xF0,0x00,0x3E,0x7C,0x00,0x0F,
    0xF0,0x00,0xFF,0xFF,0x00,0x0F,
    0xE0,0x01,0xFF,0xFF,0x80,0x07,
    0xE0,0x03,0xC0,0x03,0xC0,0x07,
    0xE0,0x07,0x80,0x01,0xE0,0x07,
    0xE0,0x07,0x00,0x00,0xE0,0x07,
    0xE0,0x07,0x00,0x00,0xE0,0x07,
    0xE0,0x07,0x80,0x01,0xE0,0x07,
    0xE0,0x03,0xC0,0x03,0xC0,0x07,
    0xE0,0x01,0xFF,0xFF,0x80,0x07,
    0xE0,0x00,0xFF,0xFF,0x00,0x07,
    0xE0,0x00,0x3E,0x7C,0x00,0x07,
    0xE0,0x00,0x00,0x00,0x00,0x07,
    0xE0,0x00,0x00,0x00,0x00,0x07,
    0xE0,0x00,0x00,0x00,0x00,0x07,
    0xE0,0x00,0x00,0x00,0x00,0x07,
    0xE0,0x00,0x7F,0xFE,0x00,0x07,
    0xE0,0x00,0xFF,0xFF,0x00,0x07,
    0xE0,0x00,0xFF,0xFF,0x00,0x07,
    0xE0,0x00,0x7F,0xFE,0x00,0x07,
    0xE0,0x00,0x00,0x00,0x00,0x07,
    0xF0,0x00,0x00,0x00,0x00,0x0F,
    0xF0,0x00,0x00,0x00,0x00,0x0F,
    0xF8,0x00,0x00,0x00,0x00,0x1F,
    0xF8,0x00,0x00,0x00,0x00,0x1F,
    0xFC,0x00,0x00,0x00,0x00,0x3F,
    0xFE,0x00,0x00,0x00,0x00,0x7F,
    0xFF,0x00,0x00,0x00,0x00,0xFF,
    0xFF,0x80,0x00,0x00,0x01,0xFF,
    0xFF,0xC0,0x00,0x00,0x03,0xFF,
    0xFF,0xF0,0x00,0x00,0x0F,0xFF,
    0xFF,0xFE,0x00,0x00,0x7F,0xFF,
    0xFF,0xFF,0xE0,0x07,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
]

app_slot = 4;
app_head_end = 0xFF;

with open("MoWatchAPP.map", "r") as f:
    lines = f.readlines()

init_addr = 0;
pattern = re.compile(r"\s+(0x[0-9a-fA-F]+)\s+([a-zA-Z_][a-zA-Z0-9_]*)")
for line in lines:
    match = pattern.match(line)
    if match:
        address, name = match.groups()
        if name == "app_init":
            init_addr = int(address, 16)
            break;

if init_addr & 1 == 0:
    init_addr = init_addr | 1

def generate_uuid():
    timestamp = str(time.time()).encode()
    hash_object = hashlib.md5()
    hash_object.update(timestamp)
    md5_hash = hash_object.hexdigest()
    uuid = "{}{}{}{}{}".format(md5_hash[0:8], md5_hash[8:12], md5_hash[12:16], md5_hash[16:20], md5_hash[20:])
    return uuid

# 创建程序识别ID
uuid = generate_uuid()

with open(inputbin, "rb") as f:
    appbin = f.read()

if os.path.isfile(outputmwa):
    os.remove(outputmwa)
    print(f"删除文件 {outputmwa}")
else:
    print(f"{outputmwa} 不存在")


with open(outputmwa, "wb+") as fi:
    fi.write(uuid.encode("utf-8"))
    fi.write(init_addr.to_bytes(4, "little"))
    fi.write(app_slot.to_bytes(1, "little"))
    fi.write(app_head_end.to_bytes(1, "little"))
    for bit in appicon_bmp:
        fi.write(bit.to_bytes(1, "little"))
    for f in appbin:
        fi.write(f.to_bytes(1, "little"))
    fi.flush()
    fi.close()

print(f"#==============================================================================#")
print(f"#应用程序生成成功: {outputmwa} , 请将 {outputmwa} 复制到手表根目录apps文件夹下。")
print(f"#==============================================================================#")
